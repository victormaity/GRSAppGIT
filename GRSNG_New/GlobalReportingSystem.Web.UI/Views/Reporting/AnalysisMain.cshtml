@model GlobalReportingSystem.Core.Models.GRS.UsersAndCyclesModel
@{
    ViewBag.Title = "AnalysisMain";
}

<div class="page-header">
    <h1>
        Analysis Report
        <small>
            <i class="ace-icon fa fa-angle-double-right"></i>
            See statistics here
        </small>
    </h1>
</div>
<div class="tabbable">
    <ul class="nav nav-tabs padding-18 tab-size-bigger" id="myTab">

        <li class="active">
            <a data-toggle="tab" href="#faq-tab-1">
                <i class="orange ace-icon fa fa-tasks bigger-120"></i>
                By cycle
            </a>
        </li>
        <li>
            <a data-toggle="tab" href="#faq-tab-2">
                <i class="blue ace-icon fa fa-user bigger-120"></i>
                By user
            </a>
        </li>
    </ul>
    <div class="tab-content no-border padding-24">
        <div id="faq-tab-1" class="tab-pane fade in active">
            <!--h4 class="blue">
                <i class="orange ace-icon fa fa-credit-card bigger-110"></i>
                Global Reporting System Info
            </h4-->


            <div class="space-8"></div>
            <div class="row">
                <div class="btn-group">
                    <button class="btn btn-info btn-white btn-lg" onclick="RenderReportByCycle()">
                        Select Test Cycle
                    </button>

                    <button data-toggle="dropdown" class="btn btn-info btn-white btn-lg dropdown-toggle">
                        <span class="ace-icon fa fa-caret-down icon-only"></span>
                    </button>
                    &nbsp;
                    <i id="loading"></i>
                    <ul class="dropdown-menu dropdown-info dropdown-menu-right" id="cycles">
                        @{
                            var counter = 1;
                            var classname = "";
                            foreach (var cycle in Model.Cycles)
                            {
                                if (counter == 1)
                                {
                                    classname = "selected";
                                }
                                <li>
                                    <a id="@cycle.ID" class="@classname" onclick="SetSelected(@cycle.ID, 'cycles');">@cycle.CycleName</a>
                                </li>
                                counter = 0;
                                classname = "";
                            }
                        }
                    </ul>
                </div>
                <br />
                <br />
                <div class="row">
                    <div class="col-xs-12">
                        <div id="analisysReportByCycle"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="faq-tab-2" class="tab-pane fade">
            <div class="space-8"></div>
            <div class="row">
                <div class="btn-group">
                    <button class="btn btn-info btn-white btn-lg" onclick="RenderReportByUser()">
                        Select user
                    </button>

                    <button data-toggle="dropdown" class="btn btn-info btn-white btn-lg dropdown-toggle">
                        <span class="ace-icon fa fa-caret-down icon-only"></span>
                    </button>


                    <ul class="dropdown-menu dropdown-info dropdown-menu-right" id="users">
                        @{
                            counter = 0;
                            foreach (var user in Model.Analysers)
                            {

                                if (counter == 1)
                                {
                                    classname = "selected";
                                }
                                <li>
                                    <a id="@user.ID" selected="@classname" onclick="SetSelected(@user.ID, 'users');">@user.USerFullName</a>
                                </li>
                                counter = 0;
                                classname = "";
                            }
                        }
                    </ul>
                </div>
                <input class="btn btn-info btn-white btn-lg" id="datepicker" readonly="readonly">
                <i id="loadingUser"></i>
                <br />
                <br />
                <div class="row">
                    <div class="col-xs-12">
                        <div id="analisysReportByUser"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">

    $(document).ready(function () {
        $('#datepicker').datepicker({
            format: "dd-MM-yyyy",
            //autoclose: true,
            //date when functionality was committed. There is no data for erlier dates
            //startDate: '15-June-2015',
            endDate: '+0d',
            multidate: true,
            todayHighlight: true
        });
        $("#datepicker").datepicker("setDate", Date());
    });

    function SetSelected(currId, tagId) {
        var array = $("#" + tagId + " > li > a");
        for (var i = 0; i < array.length; i++) {
            $('#' + array[i].id).removeClass("selected");
        }
        $("#" + currId).addClass("selected");
        var name = $("#" + currId).text();
        $("#" + tagId).siblings("button").first().text(name)
    }

    function RenderReportByCycle() {
        var id = $("#cycles > li > a[class='selected']").attr('id');

        $.ajax({
            type: "POST",
            url: "@Url.Action("AnalysisTableByCycle", "Reporting")",
            async: true,
            data: "{'cycleId':" + id + "}",
            contentType: "application/json; charset=utf-8",
            dataType: "html",
            beforeSend: function () {
                $("#loading").addClass("fa fa-spinner blue fa-spin");
            },
            error: function () {
                $("#loading").removeClass("fa fa-spinner blue fa-spin");
            },
            success: function (msg) {
                $("#loading").removeClass("fa fa-spinner blue fa-spin");
                if (IsJsonString(msg) && jQuery.parseJSON(msg).type == "Error") {
                    ShowMessage(jQuery.parseJSON(msg).type, jQuery.parseJSON(msg).text);
                } else {
                    $("#analisysReportByCycle").html(msg.trim());
                }
            }
        });
    }
    function RenderReportByUser() {
        var id = $("#users > li > a[class='selected']").attr('id');
        var dates = $("#datepicker").val();
        if (dates.split(",").length == 2) {
            var startDate = dates.split(",")[0];
            var endDate = dates.split(",")[1];
        }
        else {
            var startDate = dates;
            var endDate = null;
        }
        $.ajax({
            type: "POST",
            url: "@Url.Action("AnalysisTableByUser", "Reporting")",
            async: true,
            data: "{'userId':" + id + ", 'startDate':'"+startDate+"', 'endDate':'"+endDate+"'}",
            contentType: "application/json; charset=utf-8",
            dataType: "html",
            beforeSend: function () {
                $("#loadingUser").addClass("fa fa-spinner blue fa-spin");
            },
            error: function () {
                $("#loadingUser").removeClass("fa fa-spinner blue fa-spin");
            },
            success: function (msg) {
                $("#loadingUser").removeClass("fa fa-spinner blue fa-spin");
                if (IsJsonString(msg) && jQuery.parseJSON(msg).type == "Error") {
                    ShowMessage(jQuery.parseJSON(msg).type, jQuery.parseJSON(msg).text);
                } else {
                    $("#analisysReportByUser").html(msg.trim());
                }
            }
        });
    }
    </script>
